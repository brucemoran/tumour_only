#! R

#' Take PCGR and CPSR TSVs from current dir and combine per sample
#' naming comes from input files, each single file generated by PCGR
#'
#' @param path character, path to multiple *tiers.tsv files (default: getwd())
#' @param pattern character, pattern to match files (default: "tiers.tsv$")
#' @param delim character, delimiter to split filenames, first element is name for output (default: "\\.")
#' @param out_tag character, name of output file (default: NULL)

combine_tsvs <- function(path = getwd(),
                          pattern = "tiers.tsv$",
                          delim = "\\.",
                          pcgr = TRUE,
                          out_tag = NULL){

  ##create named list of tsv input
  name_func <- function(f){
                unlist(lapply(f, function(ff){
                  strsplit(x = ff,
                           split = delim)[[1]][1]
                }))
               }

  path_vec <- dir(path = path,
                  pattern = pattern)

  if(length(grep("cpsr", path_vec[2]))>0){
    pcgr <- FALSE
  }

  out_nm <- paste(strsplit(path_vec[2], delim)[[1]][-1], collapse = gsub("\\\\", "", delim))

  tsv_gc_list <- lapply(path_vec, function(f){
                          nm <- strsplit(x = f,
                                         split = delim)[[1]][1]
                          tf <- readr::read_tsv(f)
                          gc <- tf$GENOMIC_CHANGE
                          list("tsv" = tf, "GENOMIC_CHANGE" = gc)
                        })

  names(tsv_gc_list) <- name_func(path_vec)

  ##take all GENOMIC_CHANGE as unique ID, tabulate, then per-sample
  all_gc_tab <- table(unlist(lapply(tsv_gc_list, function(f){
                                f[[2]]
                               })))
  all_gc_tb <- tibble::tibble(GENOMIC_CHANGE = names(all_gc_tab),
                              n_samples = c(all_gc_tab))

  all_gc_smp <- purrr::reduce(lapply(seq_along(tsv_gc_list), function(f){
                                  tibble::tibble(GENOMIC_CHANGE = tsv_gc_list[[f]][[2]],
                                                 sampleID = names(tsv_gc_list)[f])
                                  }),
                                  dplyr::full_join,
                                  by = "GENOMIC_CHANGE")

  for(x in 1:dim(all_gc_smp)[1]){
    all_gc_smp$sampleID.x[x] <- gsub(",NA|NA,", "",
                                     paste(all_gc_smp[x, 2:dim(all_gc_smp)[2]],
                                           collapse = ","))
  }

  all_gc_tbsmp <- dplyr::left_join(dplyr::select(.data = all_gc_smp,
                                               GENOMIC_CHANGE,
                                               sampleID = sampleID.x),
                                   all_gc_tb)

  all_tsv_tb <- tibble::as_tibble(
                    data.table::rbindlist(
                      lapply(tsv_gc_list, function(f){
                                return(f[[1]])
                               })))

  if(pcgr == TRUE){
    all_tsv_tbu <- unique(dplyr::select(.data = all_tsv_tb,
                                                 SYMBOL,
                                                 GENE_NAME,
                                                 HGVSp,
                                                 TIER,
                                                 CLINVAR,
                                                 CLINVAR_CLNSIG,
                                                 DP_TUMOR,
                                                 AF_TUMOR,
                                                 tidyselect::everything(),
                                                 -VCF_SAMPLE_ID))
  } else {
    all_tsv_tbu <- unique(dplyr::select(.data = all_tsv_tb,
                                                 SYMBOL,
                                                 GENE_NAME,
                                                 HGVSp,
                                                 CONSEQUENCE,
                                                 DBSNP,
                                                 CLINVAR_CLASSIFICATION,
                                                 CLINVAR_PHENOTYPE,
                                                 tidyselect::everything(),
                                                 -VCF_SAMPLE_ID,
                                                 -GENOTYPE))

  }
  tsv_tb <- dplyr::left_join(all_gc_tbsmp, all_tsv_tbu, by = "GENOMIC_CHANGE")
  readr::write_tsv(x = tsv_tb,
                   file = paste0(out_tag, ".", out_nm, ".combined.tsv"))
}
